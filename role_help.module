<?php
// $Id$
// role_help

/**
 * @file
 * The Role Help module allows a site admin (with the 'administer access control' permission)
 * to set a description of each role.
 * These are shown to users on a site help page. This works in the same way as the filter tips
 * page: only the role descriptions a user has access to are shown.
 * Help text for each role is set on the role's edit page ('edit role' on admin/user/roles),
 * except for the anonymous user and authenticated user roles, whose help text is set on
 * a separate admin page.
 * Help text uses the default site input format, unless you set a different format for all
 * role help text on the role help admin page.
 */

/**
 * Implementation of hook_help().
 */
function role_help_help($section='') {
  $output = '';

  switch ($section) {
    // main help page
    case "admin/help#role_help":
      $output = '<p>'.  t("The Role Help module displays a help page that is tailored to a user, showing information for each role they have assigned to them. This is visible to anonymous users only if a description is set for that role.") .'</p>';
      $output .= '<p>'. t("Set description text for a role on its settings pages.") .'</p>';
      $output .= t('<p>You can</p>
<ul>
<li>set a description for each role on its <a href="@admin-roles-page">settings page</a>.</li>
<li>set descriptions for the anonymous and authenticated roles on the <a href="@admin-role-help-page">role help settings page</a>.</li>
<li>set the input format for all role help text on the <a href="@admin-role-help-page">role help settings page</a>.</li></ul>',
        array(
          '@admin-roles-page' => url('admin/user/roles'),
          '@admin-role-help-page' => url('admin/user/role_help'),
        )) .'';
      return $output;
    case "admin/user/role_help":
      $output = '<p>Set descriptions for the anonymous user and authenticated user roles here. Descriptions for other roles are set on each role\'s settings page. You can also set an input format for all role help texts here.</p>';
      return $output;
      
  }
} // function role_help_help


/**
 * Implementation of hook_menu().
 */
function role_help_menu($may_cache) {
  global $user;
  
  // anonymous users have access if there is a description for that role
  $anon_access = db_result(db_query('SELECT description FROM {role_help} WHERE rid = 1')) ? 1 : 0;

  if ($may_cache) {
    $items[] = array(
      'path' => 'help/roles',
      'title' => t('Site help'),
      'access' => $user->uid || $anon_access,
      'callback' => 'role_help_page',
      'type' => MENU_NORMAL_ITEM,      
    );
    $items[] = array(
      'path' => 'admin/user/role_help',
      'title' => t('Role help settings'),
      'description' => t('Set the input format and role help text for anonymous and authorized roles.'),      
      'access' => user_access('administer access control'),
      'callback' => 'drupal_get_form',
      'callback arguments' => array('role_help_admin_settings'),
      'type' => MENU_NORMAL_ITEM,      
    );
  }
  return $items;
} // function role_help_menu


/**
 * Implementation of hook_form_alter().
 */
function role_help_form_alter($form_id, &$form) {
  if ('user_admin_role' == $form_id) {
    // role edit form
    // add a text area for the role's help text
    $result = db_query('SELECT description FROM {role_help} WHERE rid = %d', $form['rid']['#value']);
    $description = db_result($result);

    $form['role_help'] = array(
      '#type' => 'textarea',
      '#title' => t('Help text'),
      '#default_value' => $description,
      '#description' => t('A description of what a user with this role can accomplish. This will be shown to users on the site help page.'),
      '#weight' => -5,
    ); 
    $form['name']['#weight'] = -10;
    $form['#submit']['role_help_user_admin_role_form_submit'] = array();   
  }
} // function role_help_form_alter


/**
 * Custom submit function for user_admin_role form
 * submit form: save or update text, delete with role
 */
function role_help_user_admin_role_form_submit($form_id, $form_values) {
  if ($form_values['op'] == t('Save role')) {
    if ($form_values['role_help'] != '') {
      // text set: update or insert an entry
      $result = db_query("SELECT description from {role_help} WHERE rid = %d", $form_values['rid']['#value']);
      if (db_num_rows($result)) {
        db_query("UPDATE {role_help} SET description = '%s' WHERE rid = %d", $form_values['role_help'], $form_values['rid']);
      }
      else {
        db_query("INSERT INTO {role_help} (rid, description) VALUES (%d, '%s')", $form_values['rid']['#value'], $form_values['role_help']);    
      }         
      drupal_set_message(t('The role help text has been saved.'));
    }
    else {
      // text blanked: delete entry
      db_query('DELETE FROM {role_help} WHERE rid = %d', $form_values['rid']);    
    }
  } 
  else if ($form_values['op'] == t('Delete role')) {
    // role deleted: delete entry
    db_query('DELETE FROM {role_help} WHERE rid = %d', $form_values['rid']);
  }
} // function role_help_user_admin_role_form_submit


/**
 * Display the role help admin settings page
 * set the description for the anonymous and authorized users here
 */
function role_help_admin_settings() {
  $result = db_query('SELECT rid, description FROM {role_help} WHERE rid IN (%d, %d)', 1, 2); 
  while ($item = db_fetch_array($result)) {
    $descriptions[$item['rid']] = $item['description'];
  }
  $form['#submit'] = array('role_help_admin_settings_submit' => array());

  $form['anonymous_help'] = array(
      '#type' => 'textarea',
      '#title' => t('Anonymous user'),
      '#default_value' => $descriptions[1],
      '#description' => t('A description of what an anonymous user can accomplish. You should only set this if anonymous users have rights beyond accessing content. If non-empty, this will be shown to anonymous users on the site help page.'),
    ); 
  $form['authenticated_help'] = array(
      '#type' => 'textarea',
      '#title' => t('Authenticated user'),
      '#default_value' => $descriptions[2],
      '#description' => t('A description of what an authenticated user can accomplish. If non-empty, this will be shown to authenticated users on the site help page. You should only'),
    ); 
    

  $form['role_help_format'] = filter_form(variable_get('role_help_format', FILTER_FORMAT_DEFAULT));    
  $form['role_help_format']['#collapsible'] = 0;
  $form['role_help_format']['#collapsed'] = 0;
  $form['role_help_format']['#description'] = 'The input format to use for all role help text.';
    
  $form['submit'] = array('#type' => 'submit', '#value' => t('Save configuration') );

  return $form;  
} // function role_help_admin_settings


/**
 * Submit function for admin settings form
 * submit form: save or update text, delete if blanked
 */
function role_help_admin_settings_submit($form_id, &$form_values) {
  variable_set('role_help_format', $form_values['format']);

  foreach (array(1 => 'anonymous_help', 2 => 'authenticated_help') as $rid => $role) {
    if ($form_values[$role] != '') {
      #dsm($form_values[$role]);
      
      // update or insert into role_help table
      $result = db_query("SELECT description from {role_help} WHERE rid = %d", $rid);
      if (db_num_rows($result)) {
        db_query("UPDATE {role_help} SET description = '%s' WHERE rid = %d", $form_values[$role], $rid);
      }
      else {
        db_query("INSERT INTO {role_help} (rid, description) VALUES (%d, '%s')", $rid, $form_values[$role]);    
      }         
    }
    else {
      db_query('DELETE FROM {role_help} WHERE rid = %d', $rid);    
    }
  }
  // clear cache so anon users either gain or lose the site help menu item
  cache_clear_all('*', 'cache_menu', TRUE);
  
  
  drupal_set_message(t('The role help settings have been saved.'));
} // function role_help_admin_settings_submit


/**
 * Display the role help page to users
 * access control admins are shown all roles
 */
function role_help_page() {

  if (user_access('administer access control')) {
    $header = t('You are an access control administrator. All roles with help text are listed below:');
  
    $result = db_query("SELECT name, description FROM {role} r INNER JOIN {role_help} h ON r.rid = h.rid");    
  }
  else {
    $header = t('Your user account is enabled to do the following on this site:');

    global $user;
    $user_rids = array_keys($user->roles);
    $placeholders = implode(',', array_fill(0, count($user_rids), '%d'));
    $result = db_query("SELECT name, description FROM {role} r INNER JOIN {role_help} h ON r.rid = h.rid WHERE r.rid IN ($placeholders) ORDER BY r.rid", $user_rids );  
  }
  if (db_num_rows($result) == 0) {
    $header = t('No role help text has been set.');
  }
  $output .= "<p>$header</p>";
  
  while ($item = db_fetch_array($result)) {
    $output .= theme('role_help', $item['name'], $item['description']);
  }
  
  return $output;
} // function role_help_page


/**
 * Theme a role help section
 */
function theme_role_help($name, $description) {
  $output .= '<h3>'. ucfirst($name) .'</h3>';
  $output .= '<div>'. check_markup($description, variable_get('role_help_format', FILTER_FORMAT_DEFAULT), FALSE) .'</div>';
  return $output;
} // function theme_role_help

